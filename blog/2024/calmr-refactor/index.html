<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> calmr refactor | victor_navarro </title> <meta name="author" content="Victor M. Navarro"> <meta name="description" content="a calmr calmr"> <meta name="keywords" content="academic-website, learning, psychology"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico?c6c29525ced1316e819daec1c936442f"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://victor-navarro.github.io/blog/2024/calmr-refactor/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?bbadb8e3955ca543a14cffbb8e2772a1"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> victor_navarro </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/calmr/">calmr </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">calmr refactor</h1> <p class="post-meta"> February 19, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>I spent a good part of last week refactoring my <a href="https://victornavarro.org/calmr" rel="external nofollow noopener" target="_blank">calmr</a> package. The whole thing was motivated by creating an <em>add-on</em> package that included time-based models. Funnily enough, while developing this new package, I found myself rewriting some of the core functionalities in the base package so as to make them flexible enough to accommodate both trial- and time-based models. It did not work.</p> <p>After a week of hair-pulling, I’ve finalized all changes and merged the experimental branch into the main branch of the <a href="https://github.com/victor-navarro/calmr" rel="external nofollow noopener" target="_blank">github repository</a>.</p> <h3 id="a-calmr-calmr">A calmr calmr</h3> <p>In the refactor, I rewrote some of the S4 classes. The CalmrModel class plays a less pivotal role; it has been superseded in importance by the CalmrExperiment class. In fact, pretty much everything revolves around experiments now. Here is a little flow diagram that explains the current organization.</p> <pre><code class="language-mermaid">stateDiagram
    state "Design data.frame" as s1
    state "CalmrExperiment" as exp1
    state "CalmrExperiment" as exp2
    state "CalmrResults" as res
    state "Plots/Graphs" as pg
    state "Usable results" as ures
    s1--&gt;exp1: make_experiment fn
    s1--&gt;exp2: run_experiment fn
    exp2--&gt;res: has
    exp1--&gt;res: does not have
    exp2--&gt;pg: plot/graph methods
    exp2--&gt;ures: results method
</code></pre> <p>The diagram above encapsulates the two biggest use cases for the package: 1) running quick simulations, and 2) model fitting.</p> <p>If you just want to get a quick and dirty simulation, you can make your way through with a design <code class="language-plaintext highlighter-rouge">data.frame</code>, a model string, and the <code class="language-plaintext highlighter-rouge">run_experiment</code> function.</p> <p>If you are in the business of model fitting. Then you can precompute experiment arguments using <code class="language-plaintext highlighter-rouge">make_experiment</code> and pass that to your model function.</p> <p>I think I finally got the hang of generic methods, so I’ve renamed many of the clumsy calmr_<em>something</em> functions into just <em>something</em>. I’ve also added some getter and setter methods not shown above. For example, the <code class="language-plaintext highlighter-rouge">parameters</code> method for CalmrExperiment objects will return a list of the parameters for the experiment (which otherwise is accessible at experiment@arguments$parameters). More importantly, calling <code class="language-plaintext highlighter-rouge">parameters(experiment) &lt;- new_parameters</code> lets you set the parameters for the experiment whilst tricking you into thinking <code class="language-plaintext highlighter-rouge">experiment</code> is mutable.</p> <h3 id="extra-stuff">Extra stuff</h3> <h5 id="more-tests">More tests</h5> <p>The previous version of the package had around 40 tests, and now it is sitting close to 90! I cannot emphasize enough how important these tests were, and how satisfying it is to go from 20 to 80 passed tests by fixing one single line of code.</p> <h5 id="more-flexibility">More flexibility</h5> <p>The package now seamlessly supports many models in an experiment, thanks to the <code class="language-plaintext highlighter-rouge">c</code> method for <code class="language-plaintext highlighter-rouge">CalmrExperiments</code>. Just run two experiments (or better yet, use the <code class="language-plaintext highlighter-rouge">compare_models</code> function) and the results will include many models per output. This functionality was key for fixing the methods associated with representational similarity analysis (I really need to write an article about that).</p> <h5 id="simpler-app">Simpler app</h5> <p>With the refactor of the main package, I had to refactor the <code class="language-plaintext highlighter-rouge">calmr</code> <code class="language-plaintext highlighter-rouge">shiny</code> app. I did a pass on the janky HTML code for the header and reorganized some of the widgets. I reactivated the app’s sidebar and threw some of the options there. I also removed some of the options to maintain simplicity.</p> <h3 id="the-last-10-takes-90-of-the-time">The last 10% takes 90% of the time</h3> <p>At some point, I was happy enough to merge the experimental branch into the main branch. All tests passed. Documentation built correctly. Vignettes were knitted. The website was ready and so were the <code class="language-plaintext highlighter-rouge">gh-pages</code> actions.</p> <p>And so I pushed.</p> <p>And the website failed to deploy.</p> <p>The logs disclosed an obscure <code class="language-plaintext highlighter-rouge">pak</code> error with nothing else than a <code class="language-plaintext highlighter-rouge">failed to build source package</code> message. I install my local copy of the package using pak with no trouble, but installing from the freshly pushed repository failed with the same message. You hate to google an error and see another person asking a similar question, alas, with no solution on the horizon.</p> <p>So this is for you, in case you google has brought you here. I am sure this is unlikely to be what’s happening with your pak installation.</p> <p>In my case, I renamed some R/ files to their lowercase version (i.e., RSA.R to rsa.R). The <code class="language-plaintext highlighter-rouge">Collate</code> field in the <code class="language-plaintext highlighter-rouge">DESCRIPTION</code> file of the package does not automatically update and <code class="language-plaintext highlighter-rouge">devtools</code> kept throwing warnings, so I modified it by hand. Yet, when I merged the experimental into the main branch, the <code class="language-plaintext highlighter-rouge">DESCRIPTION</code> file was changed accordingly, but the R files I modified did not. That was the whole problem, hidden by <code class="language-plaintext highlighter-rouge">pak</code>, and revealed by <code class="language-plaintext highlighter-rouge">devtools::build()</code>. So, one file renaming latter, the website was online.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/keep-pigeons-close/">keeping pigeons close to our hearts</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2015/first-post/">CEMC simulator repository available at github</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/animation-super-simple/">gganimate</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2019/minimal-setup/">have a computer? program an experiment</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/calmr/">calmr package</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Victor M. Navarro. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script> <script src="https://d3js.org/d3.v7.min.js"></script> <script>let theme=localStorage.getItem("theme");document.querySelectorAll("pre>code.language-mermaid").forEach(e=>{const t=e.textContent,a=e.parentElement;a.classList.add("unloaded");let n=document.createElement("pre");n.classList.add("mermaid");const d=document.createTextNode(t);n.appendChild(d),a.after(n)}),mermaid.initialize({theme:theme}),"undefined"!=typeof d3&&window.addEventListener("load",function(){d3.selectAll(".mermaid svg").each(function(){var e=d3.select(this);e.html("<g>"+e.html()+"</g>");var t=e.select("g"),a=d3.zoom().on("zoom",function(e){t.attr("transform",e.transform)});e.call(a)})});</script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?4a129fbf39254905f505c7246e641eaf"></script> <script defer src="/assets/js/copy_code.js?7254ae07fe9cc5f3a10843e1c0817c9c" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>